@inject HttpClient Http
@inject NavigationManager Navigation
@implements IDisposable

<header class="header">
    <div class="container header-content">
        <div class="logo-container">
            <div class="logo">
                <img src="/images/logo.png" alt="SSCA Logo" />
            </div>
            <div class="brand-text">
                <h2>南素里基督教会</h2>
                <h3>South Surrey Christian Assembly</h3>
            </div>
        </div>
        <nav class="nav hidden-mobile">
            <a href="/" class="@(IsActive("/") ? "active" : "")">Home</a>
            <a href="/sunday-messages" class="@(IsActive("/sunday-messages") ? "active" : "")">主日信息</a>
            <a href="/gospel-meetings" class="@(IsActive("/gospel-meetings") ? "active" : "")">福音聚会</a>
            <a href="/special-meetings" class="@(IsActive("/special-meetings") ? "active" : "")">特别聚会</a>
            <a href="/contact" class="@(IsActive("/contact") ? "active" : "")">联系我们</a>
            @if (isAuthenticated)
            {
                <a href="/mgmt/meetings" class="btn-admin-nav">管理后台 Admin</a>
            }
        </nav>
        <div style="display: flex; align-items: center; gap: 1rem;">
            @if (isAuthenticated)
            {
                <div class="user-info hidden-mobile">
                    <span class="user-name">@userName</span>
                    <a href="/.auth/logout?post_logout_redirect_uri=/" class="btn btn-secondary btn-md">
                        <span>Logout</span>
                    </a>
                </div>
            }
            else
            {
                <a href="/.auth/login/aad?post_login_redirect_uri=/" class="btn btn-primary btn-md hidden-mobile">
                    <span>Login</span>
                </a>
            }
            <button class="mobile-menu-btn hidden-desktop" @onclick="ToggleMobileMenu">
                <span class="material-symbols-outlined">@(isMobileMenuOpen ? "close" : "menu")</span>
            </button>
        </div>
    </div>
    
    @* Mobile Menu *@
    @if (isMobileMenuOpen)
    {
        <div class="mobile-menu hidden-desktop">
            <nav class="mobile-nav">
                <a href="/" @onclick="CloseMobileMenu">Home</a>
                <a href="/sunday-messages" @onclick="CloseMobileMenu">主日信息</a>
                <a href="/gospel-meetings" @onclick="CloseMobileMenu">福音聚会</a>
                <a href="/special-meetings" @onclick="CloseMobileMenu">特别聚会</a>
                <a href="/contact" @onclick="CloseMobileMenu">联系我们</a>
                @if (isAuthenticated)
                {
                    <a href="/mgmt/meetings" @onclick="CloseMobileMenu" class="mobile-admin-link">管理后台 Admin</a>
                }
            </nav>
            @if (isAuthenticated)
            {
                <div class="mobile-user-info">
                    <span class="user-name">@userName</span>
                </div>
                <a href="/.auth/logout?post_logout_redirect_uri=/" class="btn btn-secondary btn-md mobile-login-btn" @onclick="CloseMobileMenu">
                    <span>Logout</span>
                </a>
            }
            else
            {
                <a href="/.auth/login/aad?post_login_redirect_uri=/" class="btn btn-primary btn-md mobile-login-btn" @onclick="CloseMobileMenu">
                    <span>Login</span>
                </a>
            }
        </div>
    }
</header>

@code {
    private bool isMobileMenuOpen = false;
    private bool isAuthenticated = false;
    private string userName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        Navigation.LocationChanged += HandleLocationChanged;
        await CheckAuthenticationState();
    }

    private void HandleLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        StateHasChanged();
    }

    private bool IsActive(string href)
    {
        var uri = new Uri(Navigation.Uri);
        var path = uri.AbsolutePath;
        if (href == "/") return path == "/";
        return path.StartsWith(href, StringComparison.OrdinalIgnoreCase);
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= HandleLocationChanged;
    }

    private async Task CheckAuthenticationState()
    {
        try
        {
            var response = await Http.GetAsync("/.auth/me");
            if (response.IsSuccessStatusCode)
            {
                var authData = await response.Content.ReadFromJsonAsync<AuthData>();
                if (authData?.ClientPrincipal != null)
                {
                    isAuthenticated = true;
                    // Priority list for finding a display name
                    var claims = authData.ClientPrincipal.Claims ?? Array.Empty<Claim>();
                    
                    // Priority list for finding a display name
                    string? nameClaim = 
                        claims.FirstOrDefault(c => string.Equals(c.typ, "name", StringComparison.OrdinalIgnoreCase))?.val ??
                        claims.FirstOrDefault(c => string.Equals(c.typ, "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name", StringComparison.OrdinalIgnoreCase))?.val ??
                        claims.FirstOrDefault(c => string.Equals(c.typ, "given_name", StringComparison.OrdinalIgnoreCase))?.val ??
                        claims.FirstOrDefault(c => string.Equals(c.typ, "preferred_username", StringComparison.OrdinalIgnoreCase))?.val;

                    userName = nameClaim ?? authData.ClientPrincipal.UserDetails ?? "User";
                }
            }
        }
        catch
        {
            isAuthenticated = false;
        }
    }

    private void ToggleMobileMenu() => isMobileMenuOpen = !isMobileMenuOpen;
    private void CloseMobileMenu() => isMobileMenuOpen = false;

    private class AuthData { public ClientPrincipal? ClientPrincipal { get; set; } }
    private class ClientPrincipal { public string? UserDetails { get; set; } public Claim[]? Claims { get; set; } }
    private class Claim { public string? typ { get; set; } public string? val { get; set; } }
}
