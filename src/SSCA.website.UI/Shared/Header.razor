@inject HttpClient Http

<header class="header">
    <div class="container header-content">
        <div class="logo-container">
            <div class="logo">
                <img src="/images/logo.png" alt="SSCA Logo" />
            </div>
            <div class="brand-text">
                <h2>SSCA-BC</h2>
                <h3>南素里基督教会</h3>
            </div>
        </div>
        <nav class="nav hidden-mobile">
            <a href="/" class="active">Home</a>           
            <a href="/sunday-messages">主日信息</a>
            <a href="/gospel-meetings">福音聚会</a>
            <a href="/special-meetings">特别聚会</a>
            <a href="/contact">联系我们</a>
            @if (isAuthenticated)
            {
                <a href="/mgmt/meetings">管理聚会</a>
                <a href="/mgmt/bulletin">管理单张</a>
            }
        </nav>
        <div style="display: flex; align-items: center; gap: 1rem;">
            @if (isAuthenticated)
            {
                <div class="user-info hidden-mobile">
                    <span class="user-name">@userName</span>
                    <a href="/.auth/logout?post_logout_redirect_uri=/" class="btn btn-secondary btn-md">
                        <span>Logout</span>
                    </a>
                </div>
            }
            else
            {
                <a href="/.auth/login/aad?post_login_redirect_uri=/" class="btn btn-primary btn-md hidden-mobile">
                    <span>Login</span>
                </a>
            }
            <button class="mobile-menu-btn hidden-desktop" @onclick="ToggleMobileMenu">
                <span class="material-symbols-outlined">@(isMobileMenuOpen ? "close" : "menu")</span>
            </button>
        </div>
    </div>
    
    @* Mobile Menu *@
    @if (isMobileMenuOpen)
    {
        <div class="mobile-menu hidden-desktop">
            <nav class="mobile-nav">
                <a href="/" @onclick="CloseMobileMenu">Home</a>
                <a href="/sunday-messages" @onclick="CloseMobileMenu">主日信息</a>
                <a href="/gospel-meetings" @onclick="CloseMobileMenu">福音聚会</a>
                <a href="/special-meetings" @onclick="CloseMobileMenu">特别聚会</a>
                <a href="/contact" @onclick="CloseMobileMenu">联系我们</a>
                @if (isAuthenticated)
                {
                    <a href="/mgmt/meetings" @onclick="CloseMobileMenu">管理聚会</a>
                    <a href="/mgmt/bulletin" @onclick="CloseMobileMenu">管理单张</a>
                }
            </nav>
            @if (isAuthenticated)
            {
                <div class="mobile-user-info">
                    <span class="user-name">@userName</span>
                </div>
                <a href="/.auth/logout?post_logout_redirect_uri=/" class="btn btn-secondary btn-md mobile-login-btn" @onclick="CloseMobileMenu">
                    <span>Logout</span>
                </a>
            }
            else
            {
                <a href="/.auth/login/aad?post_login_redirect_uri=/" class="btn btn-primary btn-md mobile-login-btn" @onclick="CloseMobileMenu">
                    <span>Login</span>
                </a>
            }
        </div>
    }
</header>

@code {
    private bool isMobileMenuOpen = false;
    private bool isAuthenticated = false;
    private string userName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await CheckAuthenticationState();
    }

    private async Task CheckAuthenticationState()
    {
        try
        {
            var response = await Http.GetAsync("/.auth/me");
            if (response.IsSuccessStatusCode)
            {
                var authData = await response.Content.ReadFromJsonAsync<AuthData>();
                if (authData?.ClientPrincipal != null)
                {
                    isAuthenticated = true;
                    userName = authData.ClientPrincipal.UserDetails ?? "User";
                }
            }
        }
        catch
        {
            // Auth endpoint not available (local dev), user is not authenticated
            isAuthenticated = false;
        }
    }

    private void ToggleMobileMenu()
    {
        isMobileMenuOpen = !isMobileMenuOpen;
    }

    private void CloseMobileMenu()
    {
        isMobileMenuOpen = false;
    }

    // Models for Azure Static Web Apps auth response
    private class AuthData
    {
        public ClientPrincipal? ClientPrincipal { get; set; }
    }

    private class ClientPrincipal
    {
        public string? IdentityProvider { get; set; }
        public string? UserId { get; set; }
        public string? UserDetails { get; set; }
        public string[]? UserRoles { get; set; }
    }
}

