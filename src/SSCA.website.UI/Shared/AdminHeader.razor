@inject HttpClient Http
@inject NavigationManager Navigation
@implements IDisposable

<header class="header header-admin">
    <div class="container header-content">
        <div class="logo-container">
            <div class="logo">
                <img src="/images/logo.png" alt="SSCA Logo" />
            </div>
            <div class="brand-text">
                <h2>SSCA-BC</h2>
                <h3>南素里基督教会 (Admin)</h3>
            </div>
        </div>
        <nav class="nav hidden-mobile">
            <a href="/mgmt/meetings" class="@(IsActive("/mgmt/meetings") ? "active" : "")">聚会 Meetings</a>
            <a href="/mgmt/bulletin" class="@(IsActive("/mgmt/bulletin") ? "active" : "")">主日单张 Bulletin</a>
            <a href="/" class="btn-back-to-public">返回前台 Public Site</a>
        </nav>
        <div style="display: flex; align-items: center; gap: 1rem;">
            @if (isAuthenticated)
            {
                <div class="user-info hidden-mobile">
                    <span class="user-name">@userName</span>
                    <a href="/.auth/logout?post_logout_redirect_uri=/" class="btn btn-secondary btn-md">
                        <span>Logout</span>
                    </a>
                </div>
            }
            <button class="mobile-menu-btn hidden-desktop" @onclick="ToggleMobileMenu">
                <span class="material-symbols-outlined">@(isMobileMenuOpen ? "close" : "menu")</span>
            </button>
        </div>
    </div>
    
    @* Mobile Menu *@
    @if (isMobileMenuOpen)
    {
        <div class="mobile-menu hidden-desktop">
            <nav class="mobile-nav">
                <a href="/mgmt/meetings" @onclick="CloseMobileMenu">聚会 Meetings</a>
                <a href="/mgmt/bulletin" @onclick="CloseMobileMenu">主日单张 Bulletin</a>
                <a href="/" @onclick="CloseMobileMenu" class="mobile-back-link">返回前台 Public Site</a>
            </nav>
            @if (isAuthenticated)
            {
                <div class="mobile-user-info">
                    <span class="user-name">@userName</span>
                </div>
                <a href="/.auth/logout?post_logout_redirect_uri=/" class="btn btn-secondary btn-md mobile-login-btn" @onclick="CloseMobileMenu">
                    <span>Logout</span>
                </a>
            }
        </div>
    }
</header>

@code {
    private bool isMobileMenuOpen = false;
    private bool isAuthenticated = false;
    private string userName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        Navigation.LocationChanged += HandleLocationChanged;
        await CheckAuthenticationState();
    }

    private void HandleLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        StateHasChanged();
    }

    private bool IsActive(string href)
    {
        var uri = new Uri(Navigation.Uri);
        var path = uri.AbsolutePath;
        return path.StartsWith(href, StringComparison.OrdinalIgnoreCase);
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= HandleLocationChanged;
    }

    private async Task CheckAuthenticationState()
    {
        try
        {
            var response = await Http.GetAsync("/.auth/me");
            if (response.IsSuccessStatusCode)
            {
                var authData = await response.Content.ReadFromJsonAsync<AuthData>();
                if (authData?.ClientPrincipal != null)
                {
                    isAuthenticated = true;
                    userName = authData.ClientPrincipal.UserDetails ?? "User";
                }
            }
        }
        catch
        {
            isAuthenticated = false;
        }
    }

    private void ToggleMobileMenu() => isMobileMenuOpen = !isMobileMenuOpen;
    private void CloseMobileMenu() => isMobileMenuOpen = false;

    private class AuthData { public ClientPrincipal? ClientPrincipal { get; set; } }
    private class ClientPrincipal { public string? UserDetails { get; set; } }
}
