@* Hero Section Component *@
@using SSCA.website.Shared.Models
@inject HttpClient Http
@inject IConfiguration Configuration
@inject NavigationManager NavigationManager

<section class="section">
    <div class="container">
        <div class="hero" style="background-image: linear-gradient(rgba(16, 25, 34, 0.6) 0%, rgba(16, 25, 34, 0.8) 100%), url('images/hero-background.jpg');">
            <div class="hero-content">
                <h1>南素里基督教会</h1>
                <p class="hero-subtitle">South Surrey Christian Assembly</p>              
            </div>
            
            <div class="hero-actions-container">
                <div class="hero-links-section">
                    @* Dynamic Links from Management *@
                    @if (heroLinks != null && heroLinks.Count > 0)
                    {
                        <div class="dynamic-links">
                            @foreach (var link in heroLinks)
                            {
                                <a href="@GetLinkUrl(link)" target="_blank" rel="noopener noreferrer" class="btn btn-accent btn-lg dynamic-link">
                                    <span class="material-symbols-outlined">@GetLinkIcon(link)</span>
                                    <span>@link.Text</span>
                                </a>
                            }
                        </div>
                    }                  
                </div>

                <a href="@bulletinUrl" target="_blank" rel="noopener noreferrer" class="bulletin-qr-link">
                    <div class="bulletin-qr-code">
                        <div class="qr-image-wrapper">
                            @* Use the generated QR code or a static image if you prefer *@
                            <img src="@qrCodeUrl" alt="Bulletin QR Code" />
                        </div>
                        <span class="qr-label">扫码查看主日单张</span>
                        <div class="qr-viewer-hint">
                            <span class="material-symbols-outlined">open_in_new</span>
                            <span>点击打开 PDF</span>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>
</section>

<style>
    .hero-actions-container {
        display: flex;
        align-items: flex-end;
        justify-content: center;
        gap: 4rem;
        margin-top: 3rem;
        flex-wrap: wrap;
        position: relative;
        z-index: 5;
        width: 100%;
        max-width: 1000px;
    }

    .hero-links-section {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        flex: 2;
        min-width: 350px;
    }

    .dynamic-links {
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
        width: 100%;
    }

    .dynamic-link {
        width: 100%;
        justify-content: flex-start !important;
        padding-left: 2rem !important;
        animation: slideInLeft 0.5s ease-out;
    }

    .dynamic-link:nth-child(1) { animation-delay: 0s; }
    .dynamic-link:nth-child(2) { animation-delay: 0.1s; }
    .dynamic-link:nth-child(3) { animation-delay: 0.2s; }
    .dynamic-link:nth-child(4) { animation-delay: 0.3s; }
    .dynamic-link:nth-child(5) { animation-delay: 0.4s; }

    @@keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .btn-accent {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        border: none;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        transition: all 0.3s ease;
    }

    .btn-accent:hover {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
    }

    .btn-accent .material-symbols-outlined {
        margin-right: 0.5rem;
    }

    .hero-buttons {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        width: 100%;
    }

    .hero-buttons .btn {
        width: 100%;
        justify-content: flex-start !important;
        padding-left: 2rem !important; /* Visual alignment with dynamic links */
    }

    .hero-buttons .btn span:not(.material-symbols-outlined) {
        margin-left: 0.5rem;
    }

    .bulletin-qr-link {
        text-decoration: none;
        display: block;
        transition: transform 0.2s ease, filter 0.2s ease;
        position: relative;
        z-index: 10;
        cursor: pointer;
    }

    .bulletin-qr-link:hover {
        transform: translateY(-5px);
        filter: brightness(1.05);
    }

    .bulletin-qr-code {
        background: #ffffff !important; /* Force pure white */
        padding: 1.25rem;
        border-radius: 1.25rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        border: 4px solid #ffffff;
    }

    .qr-image-wrapper {
        background: white;
        padding: 0.5rem;
        border-radius: 0.5rem;
    }

    .bulletin-qr-code img {
        width: 180px;
        height: 180px;
        display: block;
    }

    .qr-label {
        font-size: 1rem;
        color: #000000 !important; /* Jet black for max contrast */
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .qr-viewer-hint {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        color: var(--primary);
        font-size: 0.8rem;
        font-weight: 600;
        margin-top: 0.25rem;
    }

    .qr-viewer-hint .material-symbols-outlined {
        font-size: 1.1rem;
    }

    @@media (max-width: 768px) {
        .hero-actions-container {
            justify-content: center;
            text-align: center;
            align-items: center;
            flex-direction: column;
        }
        
        .hero-links-section {
            align-items: center;
            width: 100%;
        }

        .dynamic-links {
            width: 100%;
            align-items: center;
        }

        .hero-buttons {
            align-items: center;
            width: 100%;
        }
    }
</style>

@code {
    private string? bulletinUrl;
    private string? qrCodeUrl;
    private List<HeroLinkDto>? heroLinks;

    protected override async Task OnInitializedAsync()
    {        
        // Use relative URL with leading slash to ensure it works from any page
        bulletinUrl = "/api/bulletin/SundayBulletin.pdf";
        
        // Get the absolute URL for the QR code generator
        var absoluteBulletinUrl = NavigationManager.ToAbsoluteUri(bulletinUrl).ToString();
        
        // Generate QR code using the absolute URL
        qrCodeUrl = $"https://api.qrserver.com/v1/create-qr-code/?size=200x200&data={Uri.EscapeDataString(absoluteBulletinUrl)}&bgcolor=ffffff";

        // Load dynamic hero links
        await LoadHeroLinks();
    }

    private async Task LoadHeroLinks()
    {
        try
        {
            heroLinks = await Http.GetFromJsonAsync<List<HeroLinkDto>>("api/hero-links");
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading hero links: {ex.Message}");
            heroLinks = new List<HeroLinkDto>();
        }
    }

    private string GetLinkUrl(HeroLinkDto link)
    {
        if (!string.IsNullOrEmpty(link.ExternalUrl))
        {
            return link.ExternalUrl;
        }
        else if (!string.IsNullOrEmpty(link.FileBlobName))
        {
            return $"/api/hero-links/files/{link.FileBlobName}";
        }
        return "#";
    }

    private string GetLinkIcon(HeroLinkDto link)
    {
        if (!string.IsNullOrEmpty(link.ExternalUrl))
        {
            // Detect common patterns
            if (link.ExternalUrl.Contains("register") || link.ExternalUrl.Contains("signup"))
                return "how_to_reg";
            if (link.ExternalUrl.Contains("form") || link.ExternalUrl.Contains("survey"))
                return "edit_note";
            return "open_in_new";
        }
        else if (!string.IsNullOrEmpty(link.FileBlobName))
        {
            var ext = System.IO.Path.GetExtension(link.FileBlobName).ToLowerInvariant();
            return ext switch
            {
                ".pdf" => "picture_as_pdf",
                ".doc" or ".docx" => "description",
                ".jpg" or ".jpeg" or ".png" or ".gif" => "image",
                _ => "attach_file"
            };
        }
        return "link";
    }
}
